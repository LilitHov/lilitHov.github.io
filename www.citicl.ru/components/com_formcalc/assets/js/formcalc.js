Element.implement({getValue:function(){switch(this.get("tag")){case"select":var t=[];return $each(this.options,function(e){e.selected&&t.push($pick(e.value,e.text))}),this.multiple?t:t[0];case"input":if(!(this.checked&&["checkbox","radio"].contains(this.type)||["hidden","text","password"].contains(this.type)))break;case"textarea":return this.value}return!1}});var SCalc=new Class({initialize:function(t,e,a){this.form=$(t),this.formula=e,this.nsigns=a||2;var i=this;this.form.getElements("input, textarea, select").each(function(t){this.isFormulaPart(t)&&(t.addEvent("change",i.calcData.bind(i)),"input"!=t.get("tag")||"radio"!=t.getAttribute("type")&&"checkbox"!=t.getAttribute("type")||t.addEvent("click",i.calcData.bind(i)),"text"!=t.getAttribute("type")&&"select"!=t.get("tag")||t.addEvent("keyup",i.calcData.bind(i)))}.bind(this)),this.calcData()},isFormulaPart:function(t){var e=!1,a=new RegExp("{"+t.name+"}");return this.formula.each(function(i){return t.name&&null!==i.match(a)?(e=!0,!1):void 0}),e},calcData:function(){var vals=[];this.form.getElements("input, textarea, select").each(function(t){if(t.name){var e=t.getValue();e!==!1&&(vals[t.name]=e)}}),this.formula.each(function(formula){var wformula=formula;for(var fld in vals)"function"!=typeof vals[fld]&&(wformula=wformula.replace(new RegExp("{"+fld+"}","gm"),vals[fld]?vals[fld].replace(",","."):0));wformula=wformula.replace(/\{.*?\}/g,"0");var result;try{result=eval(wformula)}catch(e){result=NaN}var rfield=formula.split("=")[0];rfield.trim()&&this.setResult(rfield,result)}.bind(this))},setResult:function(t,e){if(isFinite(e)){var a=Math.pow(10,this.nsigns);e=Math.round(e*a)/a,$(t).value=e,$(t+"_disp").set("text",e)}else $(t+"_disp").set("text",""),$(t).value=e}});window.addEvent("domready",function(){if($chk(__FC_FORMULA)){var t=new FormCheck("calcForm",{display:{keepFocusOnError:0,showErrors:1,checkValueIfEmpty:0},regexp:{number:/^[-+]?\d*(\.|,)?\d+$/},submit:__FC_SUBMIT});new SCalc("calcForm",__FC_FORMULA),__FC_SUBMIT||t.addEvent("validateSuccess",function(){new Request.JSON({url:"/index.php",method:"post",data:{option:"com_formcalc",task:"checkCaptcha",format:"raw",captcha:t.form.captcha.value},onSuccess:function(t){t.success?$("calcForm").submit():alert(__FC_CAPTCHA_TEXT)}}).send()})}});