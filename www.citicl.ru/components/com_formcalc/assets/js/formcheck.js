var FormCheck=new Class({Implements:[Options,Events],options:{tipsClass:"fc-tbx",errorClass:"fc-error",fieldErrorClass:"fc-field-error",submit:!0,trimValue:!1,validateDisabled:!1,submitByAjax:!1,ajaxResponseDiv:!1,ajaxEvalScripts:!1,onAjaxRequest:$empty,onAjaxSuccess:$empty,onAjaxFailure:$empty,onSubmit:$empty,onValidateSuccess:$empty,onValidateFailure:$empty,display:{showErrors:0,titlesInsteadNames:0,errorsLocation:1,indicateErrors:1,indicateErrorsInit:0,keepFocusOnError:0,checkValueIfEmpty:1,addClassErrorToField:0,removeClassErrorOnTipClosure:0,fixPngForIe:1,replaceTipsEffect:1,flashTips:0,closeTipsButton:1,tipsPosition:"right",tipsOffsetX:-45,tipsOffsetY:0,listErrorsAtTop:!1,scrollToFirst:!0,fadeDuration:300},alerts:{required:"This field is required.",alpha:"This field accepts alphabetic characters only.",alphanum:"This field accepts alphanumeric characters only.",nodigit:"No digits are accepted.",digit:"Please enter a valid integer.",digitltd:"The value must be between %0 and %1",number:"Please enter a valid number.",email:"Please enter a valid email.",image:"This field should only contain image types",phone:"Please enter a valid phone.",phone_inter:"Please enter a valid international phone number.",url:"Please enter a valid url.",confirm:"This field is different from %0",differs:"This value must be different of %0",length_str:"The length is incorrect, it must be between %0 and %1",length_fix:"The length is incorrect, it must be exactly %0 characters",lengthmax:"The length is incorrect, it must be at max %0",lengthmin:"The length is incorrect, it must be at least %0",words_min:"This field must concain at least %0 words, currently: %1 words",words_range:"This field must contain %0-%1 words, currently: %2 words",words_max:"This field must contain at max %0 words, currently: %1 words",checkbox:"Please check the box",radios:"Please select a radio",select:"Please choose a value"},regexp:{required:/[^.*]/,alpha:/^[a-z ._-]+$/i,alphanum:/^[a-z0-9 ._-]+$/i,digit:/^[-+]?[0-9]+$/,nodigit:/^[^0-9]+$/,number:/^[-+]?\d*\.?\d+$/,email:/^([a-zA-Z0-9_\.\-\+%])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,image:/.(jpg|jpeg|png|gif|bmp)$/i,phone:/^[\d\s ().-]+$/,phone_inter:/^\+{0,1}[0-9 \(\)\.\-]+$/,url:/^(http|https|ftp)\:\/\/[a-z0-9\-\.]+\.[a-z]{2,3}(:[a-z0-9]*)?\/?([a-z0-9\-\._\?\,\'\/\\\+&amp;%\$#\=~])*$/i}},initialize:function(e,t){if(this.form=$(e)){this.form.isValid=!0,this.regex=["length"],this.setOptions(t),"undefined"!=typeof formcheckLanguage&&(this.options.alerts=$merge(this.options.alerts,formcheckLanguage)),this.validations=[],this.alreadyIndicated=!1,this.firstError=!1;var i=new Hash(this.options.regexp);i.each(function(e,t){this.regex.push(t)},this),this.form.getElements("*[class*=validate]").each(function(e){"select"!=e.get("tag")&&"input"!=e.get("tag")&&"textarea"!=e.get("tag")||this.register(e)},this),this.form.addEvents({submit:this.onSubmit.bind(this)}),this.options.display.fixPngForIe&&this.fixIeStuffs(),document.addEvent("mousewheel",function(){this.isScrolling=!1}.bind(this))}},register:function(el,position){el.validation=[],el.getProperty("class").split(" ").each(function(classX){if(classX.match(/^validate(\[.+\])$/)){var valid=!0;"radio"==el.type&&this.validations.each(function(e){e.name==el.name&&(valid=!1)},this);for(var validators=eval(classX.match(/^validate(\[.+\])$/)[1]),i=0;i<validators.length;i++){if(el.validation.push(validators[i]),validators[i].match(/^confirm\[/)){var field=eval(validators[i].match(/^.+(\[.+\])$/)[1].replace(/([A-Z0-9\._-]+)/i,"'$1'"));this.form[field].validation.contains("required")&&el.validation.push("required")}validators[i].match(/^target:.+/)&&(el.target=validators[i].match(/^target:(.+)/)[1])}if(position&&position<=this.validations.length){var newValidations=[];this.validations.each(function(e,t){position==t+1&&valid&&(newValidations.push(el),this.addListener(el)),newValidations.push(e)},this),this.validations=newValidations}else valid&&(this.validations.push(el),this.addListener(el))}},this)},dispose:function(e){this.validations.erase(e)},addListener:function(e){if(e.errors=[],this.options.display.indicateErrorsInit)return this.validations.each(function(e){this.manageError(e,"submit")||(this.form.isValid=!1)},this),!0;if("submit"==e.validation[0])return e.addEvent("click",function(e){this.onSubmit(e)&&this.form.submit()}.bind(this)),!0;if(0==this.isChildType(e))e.addEvent("blur",function(){(function(){this.fxRunning||!e.element&&1!=this.options.display.showErrors||!this.options.display.checkValueIfEmpty&&!e.value||this.manageError(e,"blur")}).bind(this).delay(100)}.bind(this));else if(1==this.isChildType(e)){var t=this.form.getElements('input[name="'+e.getProperty("name")+'"]');t.each(function(t){t.addEvent("blur",function(){(function(){!e.element&&1!=this.options.display.showErrors||!this.options.display.checkValueIfEmpty&&!e.value||this.manageError(e,"click")}).bind(this).delay(100)}.bind(this))},this)}},validate:function(el){return el.errors=[],el.isOk=!0,!this.options.validateDisabled&&el.get("disabled")?!0:(this.options.trimValue&&el.value&&(el.value=el.value.trim()),el.validation.each(function(rule){if(this.isChildType(el))0==this.validateGroup(el)&&(el.isOk=!1);else{var ruleArgs=[];if(rule.match(/target:.+/))return;if(rule.match(/^.+\[/)){var ruleMethod=rule.split("[")[0];ruleArgs=eval(rule.match(/^.+(\[.+\])$/)[1].replace(/([A-Z0-9\._-]+)/i,"'$1'"))}else var ruleMethod=rule;this.regex.contains(ruleMethod)&&"select"!=el.get("tag")&&0==this.validateRegex(el,ruleMethod,ruleArgs)&&(el.isOk=!1),"confirm"==ruleMethod&&0==this.validateConfirm(el,ruleArgs)&&(el.isOk=!1),"differs"==ruleMethod&&0==this.validateDiffers(el,ruleArgs)&&(el.isOk=!1),"words"==ruleMethod&&0==this.validateWords(el,ruleArgs)&&(el.isOk=!1),("select"==el.get("tag")||"checkbox"==el.type&&"required"==ruleMethod)&&0==this.simpleValidate(el)&&(el.isOk=!1),(rule.match(/%[A-Z0-9\._-]+$/i)||el.isOk&&rule.match(/~[A-Z0-9\._-]+$/i))&&0==eval(rule.slice(1)+"(el)")&&(el.isOk=!1)}},this),!!el.isOk)},simpleValidate:function(e){return"select"==e.get("tag")&&e.selectedIndex<=0?(e.errors.push(this.options.alerts.select),!1):"checkbox"==e.type&&0==e.checked?(e.errors.push(this.options.alerts.checkbox),!1):!0},validateRegex:function(e,t,i){var s="";if(i[1]&&"length"==t?-1==i[1]?(this.options.regexp.length=new RegExp("^[\\s\\S]{"+i[0]+",}$"),s=this.options.alerts.lengthmin.replace("%0",i[0])):i[0]==i[1]?(this.options.regexp.length=new RegExp("^[\\s\\S]{"+i[0]+"}$"),s=this.options.alerts.length_fix.replace("%0",i[0])):(this.options.regexp.length=new RegExp("^[\\s\\S]{"+i[0]+","+i[1]+"}$"),s=this.options.alerts.length_str.replace("%0",i[0]).replace("%1",i[1])):i[0]&&"length"==t?(this.options.regexp.length=new RegExp("^.{0,"+i[0]+"}$"),s=this.options.alerts.lengthmax.replace("%0",i[0])):s=this.options.alerts[t],i[1]&&"digit"==t){var r=!0;if(this.options.regexp.digit.test(e.value)||(e.errors.push(this.options.alerts[t]),r=!1),-1==i[1]){var n=e.value.toInt()>=i[0].toInt();s=this.options.alerts.digitmin.replace("%0",i[0])}else{var n=e.value.toInt()>=i[0].toInt()&&e.value.toInt()<=i[1].toInt();s=this.options.alerts.digitltd.replace("%0",i[0]).replace("%1",i[1])}if(0==r||0==n)return e.errors.push(s),!1}else if(0==this.options.regexp[t].test(e.value))return e.errors.push(s),!1;return!0},validateConfirm:function(e,t){var i=t[0];if(e.value!=this.form[i].value){if(this.options.display.titlesInsteadNames)var s=this.options.alerts.confirm.replace("%0",this.form[i].getProperty("title"));else var s=this.options.alerts.confirm.replace("%0",i);return e.errors.push(s),!1}return!0},validateDiffers:function(e,t){var i=t[0];if(e.value==this.form[i].value){if(this.options.display.titlesInsteadNames)var s=this.options.alerts.differs.replace("%0",this.form[i].getProperty("title"));else var s=this.options.alerts.differs.replace("%0",i);return e.errors.push(s),!1}return!0},validateWords:function(e,t){var i=t[0],s=t[1],r=e.value.replace(/[ \t\v\n\r\f\p]/m," ").replace(/[,.;:]/g," ").clean().split(" ");if(-1==s){if(r.length<i)return e.errors.push(this.options.alerts.words_min.replace("%0",i).replace("%1",r.length)),!1}else if(i>0){if(r.length<i||r.length>s)return e.errors.push(this.options.alerts.words_range.replace("%0",i).replace("%1",s).replace("%2",r.length)),!1}else if(r.length>s)return e.errors.push(this.options.alerts.words_max.replace("%0",s).replace("%1",r.length)),!1;return!0},isFormValid:function(){return this.form.isValid=!0,this.validations.each(function(e){var t=this.manageError(e,"testonly");t||(this.form.isValid=!1)},this),this.form.isValid},isChildType:function(e){return!(!$defined(e.type)||"radio"!=e.type)},validateGroup:function(e){e.errors=[];var t=this.form[e.getProperty("name")];e.group=t;for(var i=!1,s=0;s<t.length;s++)t[s].checked&&(i=!0);return 0==i?(e.errors.push(this.options.alerts.radios),!1):!0},listErrorsAtTop:function(e){this.form.element||(this.form.element=new Element("div",{id:"errorlist","class":this.options.errorClass}).injectTop(this.form)),"collection"==$type(e)?new Element("p").set("html","<span>"+e[0].name+" : </span>"+e[0].errors[0]).injectInside(this.form.element):(e.validation.contains("required")&&e.errors.length>0||e.errors.length>0&&e.value&&0==e.validation.contains("required"))&&e.errors.each(function(t){new Element("p").set("html","<span>"+e.name+" : </span>"+t).injectInside(this.form.element)},this),window.fireEvent("resize")},manageError:function(e,t){var i=this.validate(e);if("testonly"==t)return i;if(!i&&e.validation.flatten()[0].contains("confirm[")||!i&&e.validation.contains("required")||!e.validation.contains("required")&&e.value&&!i){if(1==this.options.display.listErrorsAtTop&&"submit"==t&&this.listErrorsAtTop(e),2==this.options.display.indicateErrors||0==this.alreadyIndicated||e.name==this.alreadyIndicated.name)return this.firstError||(this.firstError=e),this.alreadyIndicated=e,this.options.display.keepFocusOnError&&e.name==this.firstError.name&&function(){e.focus()}.delay(20),this.addError(e),!1}else if(i||!e.validation.contains("required")&&!e.value)return this.removeError(e),!0;return!0},addError:function(e){var t=e.target?$(e.target).getCoordinates():e.getCoordinates();if(!e.element&&0!=this.options.display.indicateErrors)if(1==this.options.display.errorsLocation){var i="left"==this.options.display.tipsPosition?t.left:t.right,s={opacity:0,position:"absolute","float":"left",left:i+this.options.display.tipsOffsetX};e.element=new Element("div",{"class":this.options.tipsClass,styles:s}).injectInside(document.body),this.addPositionEvent(e)}else 2==this.options.display.errorsLocation?e.element=new Element("div",{"class":this.options.errorClass,styles:{opacity:0}}).injectBefore(e):3==this.options.display.errorsLocation&&(e.element=new Element("div",{"class":this.options.errorClass,styles:{opacity:0}}),"object"==$type(e.group)||"collection"==$type(e.group)?e.element.injectAfter(e.group[e.group.length-1]):e.element.injectAfter(e));if(e.element&&1!=e.element){if(e.element.empty(),1==this.options.display.errorsLocation){var r=[];e.errors.each(function(e){r.push(new Element("p").set("html",e))});var n=this.makeTips(r).injectInside(e.element);this.options.display.closeTipsButton&&n.getElements("a.close").addEvent("mouseup",function(){this.removeError(e,"tip")}.bind(this)),e.element.setStyle("top",t.top-n.getCoordinates().height+this.options.display.tipsOffsetY)}else e.errors.each(function(t){new Element("p").set("html",t).injectInside(e.element)});!this.options.display.fadeDuration||Browser.Engine.trident&&5==Browser.Engine.version&&this.options.display.errorsLocation<2?e.element.setStyle("opacity",1):(e.fx=new Fx.Tween(e.element,{duration:this.options.display.fadeDuration,ignore:!0,onStart:function(){this.fxRunning=!0}.bind(this),onComplete:function(){this.fxRunning=!1,e.element&&0==e.element.getStyle("opacity").toInt()&&(e.element.destroy(),e.element=!1)}.bind(this)}),1!=e.element.getStyle("opacity").toInt()&&e.fx.start("opacity",1))}this.options.display.addClassErrorToField&&0==this.isChildType(e)&&(e.addClass(this.options.fieldErrorClass),e.element=e.element||!0)},addPositionEvent:function(e){this.options.display.replaceTipsEffect?e.event=function(){var t=e.target?$(e.target).getCoordinates():e.getCoordinates();new Fx.Morph(e.element,{duration:this.options.display.fadeDuration}).start({left:[e.element.getStyle("left"),t.right+this.options.display.tipsOffsetX],top:[e.element.getStyle("top"),t.top-e.element.getCoordinates().height+this.options.display.tipsOffsetY]})}.bind(this):e.event=function(){var t=e.target?$(e.target).getCoordinates():e.getCoordinates();e.element.setStyles({left:t.right+this.options.display.tipsOffsetX,top:t.top-e.element.getCoordinates().height+this.options.display.tipsOffsetY})}.bind(this),window.addEvent("resize",e.event)},removeError:function(e,t){(this.options.display.addClassErrorToField&&!this.isChildType(e)&&this.options.display.removeClassErrorOnTipClosure||this.options.display.addClassErrorToField&&!this.isChildType(e)&&!this.options.display.removeClassErrorOnTipClosure&&"tip"!=t)&&e.removeClass(this.options.fieldErrorClass),e.element&&(this.alreadyIndicated=!1,e.errors=[],e.isOK=!0,window.removeEvent("resize",e.event),this.options.display.errorsLocation>=2&&e.element&&new Fx.Tween(e.element,{duration:this.options.display.fadeDuration}).start("height",0),!this.options.display.fadeDuration||Browser.Engine.trident&&5==Browser.Engine.version&&1==this.options.display.errorsLocation&&e.element?(this.fxRunning=!0,e.element.destroy(),e.element=!1,function(){this.fxRunning=!1}.bind(this).delay(200)):e.element&&1!=e.element&&e.fx.start("opacity",0))},focusOnError:function(e){if(this.options.display.scrollToFirst&&!this.alreadyFocused&&!this.isScrolling){if(this.options.display.indicateErrors&&this.options.display.errorsLocation){if(this.alreadyIndicated.element){switch(this.options.display.errorsLocation){case 1:var t=e.element.getCoordinates().top;break;case 2:var t=e.element.getCoordinates().top-30;break;case 3:var t=e.getCoordinates().top-30}this.isScrolling=!0}}else var t=e.getCoordinates().top-30;window.getScroll.y!=t?new Fx.Scroll(window,{onComplete:function(){this.isScrolling=!1,"hidden"!=e.getProperty("type")&&e.focus()}.bind(this)}).start(0,t):(this.isScrolling=!1,e.focus()),this.alreadyFocused=!0}},fixIeStuffs:function(){if(Browser.Engine.trident4)for(var e=new RegExp("url\\(([.a-zA-Z0-9_/:-]+.png)\\)"),t=new RegExp("(.+)formcheck.css"),i=0;i<document.styleSheets.length;i++)if(document.styleSheets[i].href.match(/formcheck\.css$/))for(var s=document.styleSheets[i].href.replace(t,"$1"),r=document.styleSheets[i].rules.length,n=0;r>n;n++){var o=document.styleSheets[i].rules[n].style,a=s+o.backgroundImage.replace(e,"$1");if(a&&a.match(/\.png/i)){var l="no-repeat"==o.backgroundRepeat?"crop":"scale";o.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, src='"+a+"', sizingMethod='"+l+"')",o.backgroundImage="none"}}},makeTips:function(e){var t=new Element("table");t.cellPadding="0",t.cellSpacing="0",t.border="0";var i=new Element("tbody").injectInside(t),s=new Element("tr").injectInside(i);new Element("td",{"class":"tl"}).injectInside(s),new Element("td",{"class":"t"}).injectInside(s),new Element("td",{"class":"tr"}).injectInside(s);var r=new Element("tr").injectInside(i);new Element("td",{"class":"l"}).injectInside(r);var n=new Element("td",{"class":"c"}).injectInside(r),o=new Element("div",{"class":"err"}).injectInside(n);e.each(function(e){e.injectInside(o)}),this.options.display.closeTipsButton&&new Element("a",{"class":"close"}).injectInside(n),new Element("td",{"class":"r"}).injectInside(r);var a=new Element("tr").injectInside(i);return new Element("td",{"class":"bl"}).injectInside(a),new Element("td",{"class":"b"}).injectInside(a),new Element("td",{"class":"br"}).injectInside(a),t},reinitialize:function(e){this.validations.each(function(t){t.element&&(t.errors=[],t.isOK=!0,1!=this.options.display.flashTips&&"forced"!=e||(t.element.destroy(),t.element=!1))},this),this.form.element&&this.form.element.empty(),this.alreadyFocused=!1,this.firstError=!1,this.elementToRemove=this.alreadyIndicated,this.alreadyIndicated=!1,this.form.isValid=!0},submitByAjax:function(){var e=this.form.getProperty("action");this.fireEvent("ajaxRequest"),new Request({url:e,method:this.form.getProperty("method"),data:this.form.toQueryString(),evalScripts:this.options.ajaxEvalScripts,onFailure:function(e){this.fireEvent("ajaxFailure",e)}.bind(this),onSuccess:function(e){this.fireEvent("ajaxSuccess",e),this.options.ajaxResponseDiv&&$(this.options.ajaxResponseDiv).set("html",e)}.bind(this)}).send()},onSubmit:function(e){return this.reinitialize(),this.fireEvent("onSubmit"),this.validations.each(function(e){var t=this.manageError(e,"submit");t||(this.form.isValid=!1)},this),this.form.isValid?(this.options.submitByAjax?(new Event(e).stop(),this.submitByAjax()):this.options.submit||new Event(e).stop(),this.fireEvent("validateSuccess"),!0):(new Event(e).stop(),this.elementToRemove&&this.elementToRemove!=this.firstError&&1==this.options.display.indicateErrors&&this.removeError(this.elementToRemove),this.focusOnError(this.firstError),this.fireEvent("validateFailure"),!1)}});